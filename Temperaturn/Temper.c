#include "main.h"
#include "Temper.h"
#include "Lcd.h"
#include "LcdApp.h"
#include "uart.h"

uint TEMPER = 0;
uint TEMPER_Val = 0;

//上为ADC采样值，下方左为温度值，右为数组标号
uint code temp_table[]={

    140,      149,    159,    168,    178,    188,
    //-40 0   -39 1   -38 2   -37 3   -36 4   -35 5
    199,      210,    222,    233,    246,    259,
    //-34 6   -33 7   -32 8   -31 9   -30 10  -29 11
    272,      286,    301,    317,    333,    349, 
    //-28 12  -27 13  -26  14 -25  15 -24  16 -23  17
    367,      385,    403,    423,    443,    464,
    //-22 18  -21 19  -20 20  -19 21  -18 22  -17 23
    486,      509,    533,    558,    583,    610,  
    //-16 24  -15 25  -14 26  -13 27  -12 28  -11 29
    638,      667,    696,    727,    758,    791,
    //-10 30  -9  31  -8  32  -7  33  -6  34  -5  35
    824,      858,    893,    929,    965,    1003, 
    //-4  36  -3  37  -2  38  -1  39  0   40  1   41
    1041,     1080,   1119,   1160,   1201,   1243,
    //2   42  3   43  4   44  5   45  6   46  7   47
    1285,     1328,   1371,   1414,   1459,   1503,
    //8   48  9   49  10  50  11  51  12  52  13  53
    1548,     1593,   1638,   1684,   1730,   1775,
    //14  54  15  55  16  56  17  57  18  58  19  59
    1821,     1867,   1912,   1958,   2003,   2048,
    //20  60  21  61  22  62  23  63  24  64  25  65
    2093,     2137,   2182,   2225,   2269,   2312,
    //26  66  27  67  28  68  29  69  30  70  31  71
    2354,     2397,   2438,   2479,   2519,   2559,
    //32  72  33  73  34  74  35  75  36  76  37  77
    2598,     2637,   2675,   2712,   2748,   2784,
    //38  78  39  79  40  80  41  81  42  82  43  83
    2819,     2853,   2887,   2920,   2952,   2984,
    //44  84  45  85  46  86  47  87  48  88  49  89
    3014,     3044,   3073,   3102,   3130,   3157,
    //50  90  51  91  52  92  53  93  54  94  55  95
    3183,     3209,   3234,   3259,   3283,   3306,
    //56  96  57  97  58  98  59  99  60  100 61  101
    3328,     3351,   3372,   3393,   3413,   3432,
    //62  102 63  103 64  104 65  105 66  106 67  107
    3452,     3470,   3488,   3506,   3523,   3539,
    //68  108 69  109 70  110 71  111 72  112 73  113
    3555,     3571,   3586,   3601,   3615,   3628,
    //74  114 75  115 76  116 77  117 78  118 79  119
    3642,     3655,   3667,   3679,   3691,   3702, 
    //80  120 81  121 82  122 83  123 84  124 85  125
    3714,     3724,   3735,   3745,   3754,   3764,
    //86  126 87  127 88  128 89  129 90  130 91  131
    3773,     3782,   3791,   3799,   3807,   3815,
    //92  132 93  133 94  134 95  135 96  136 97  137
    3822,     3830,   3837,   3844,   3850,   3857, 
    //98  138 99  139 100 140 101 141 102 142 103 143
    3863,     3869,   3875,   3881,   3887,   3892,
    //104 144 105 145 106 146 107 147 108 148 109 149
    3897,     3902,   3907,   3912,   3917,   3921,
    //110 150 111 151 112 152 113 153 114 154 115 155
    3926,     3930,   3934,   3938,   3942 
    //116 156 117 157 118 158 119 159 120 160
    };

void Adc_Init()
{
    P_SW2 |= 0x80;
    ADCTIM = 0x3f;      //设置 ADC 内部时序，ADC采样时间建议设最大值
    ADCCFG = 0x2f;      //设置 ADC 时钟为系统时钟/2/16/16
    ADC_CONTR = 0x80;   //使能 ADC 模块
    _nop_();
    _nop_();
    
}


int Get_Temperature(uint adc)
{
    int i;
    uint code *p;
    p = temp_table;
    if((adc >= p[0]) && (adc <= p[160]))
    {
        for(i=0;i<160;i++)
        {
            if(adc <= p[i])
            {
                i = i-1;
                return (i - 40);
            }
        }
    }
    return (-40);

}

uint Get_ADC12bitResult(u8 channel)  //channel = 0~15
{
    uint tem = 0;
    ADC_RES = 0;
    ADC_RESL = 0;

    ADC_CONTR = (ADC_CONTR & 0xe0) | 0x40 | channel;    //启动 AD 转换
    _nop_();
    _nop_();
    _nop_();
    _nop_();
    _nop_();
    
    while(!ADC_FLAG)

    {
        ;
    }
    ADC_FLAG = 0;   //清除ADC结束标志
    tem = ((uint)(ADC_RES << 8)) | ADC_RESL ;
    return  tem;
}


void ADC_Temp()
{
    TEMPER = Get_ADC12bitResult(3);       //参数0~15,查询方式做一次ADC, 返回值就是结果, == 4096 为错误
    TEMPER =  Get_Temperature(TEMPER);    //计算温度值

    TEMPER *= 10; 
    TEMPER_Val =TEMPER;
    
    //ShowTemp(TEMPER_Val);

    if (RunStatus.Running)
    {
        if(TEMPER_Val > 300)
        {
            g_Output[EX_FAN] = 1;
        }
        
        if(TEMPER_Val < 260)
        {
            g_Output[EX_FAN] = 0;
        }
    }
    else
    {
        g_Output[EX_FAN] = 0;
    }
}





















